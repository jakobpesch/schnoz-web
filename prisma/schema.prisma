// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id @default(uuid())
  name           String?       @db.VarChar(255)
  email          String?       @unique @db.VarChar(255)
  createdMatches Match[]
  participations Participant[]
}

model Participant {
  id           String @id @default(uuid())
  matchId      String
  match        Match  @relation(name: "match", fields: [matchId], references: [id], onDelete: Cascade)
  userId       String
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  score        Int    @default(0)
  move         Move[]
  Unit         Unit[]
  activePlayer Match? @relation("activePlayer")
  winner       Match? @relation("winner")
  playerNumber Int
}

model Match {
  id             String              @id @default(uuid())
  updatedAt      DateTime            @default(now()) @updatedAt
  startedAt      DateTime?
  finishedAt     DateTime?
  createdAt      DateTime            @default(now())
  createdById    String
  createdBy      User                @relation(fields: [createdById], references: [id])
  maxPlayers     Int
  status         MatchStatus         @default(CREATED)
  players        Participant[]       @relation("match")
  activePlayer   Participant?        @relation(name: "activePlayer", fields: [activePlayerId], references: [id])
  activePlayerId String?             @unique
  winner         Participant?        @relation(name: "winner", fields: [winnerId], references: [id])
  winnerId       String?             @unique
  map            Map?
  turn           Int                 @default(0)
  maxTurns       Int                 @default(12)
  openCards      UnitConstellation[] @default([])
  Rule           Rule[]
  Move           Move[]
  gameSettings   GameSettings?
}

model GameSettings {
  id      String @id @default(uuid())
  mapSize Int    @default(11)
  match   Match  @relation(fields: [matchId], references: [id])
  matchId String @unique
}

model Map {
  id       String @id @default(uuid())
  rowCount Int
  colCount Int
  tiles    Tile[]
  matchId  String @unique
  match    Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
}

model Tile {
  id      String   @id @default(uuid())
  row     Int
  col     Int
  visible Boolean  @default(false)
  terrain Terrain?
  unit    Unit?
  mapId   String
  map     Map      @relation(fields: [mapId], references: [id], onDelete: Cascade)
  Move    Move[]
}

model Move {
  id            String      @id @default(uuid())
  rotationCount Int
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id])
  targetId      String
  target        Tile        @relation(fields: [targetId], references: [id])
  match         Match       @relation(fields: [matchId], references: [id], onDelete: Cascade)
  matchId       String
}

model Unit {
  id      String       @id @default(uuid())
  type    UnitType
  ownerId String?
  owner   Participant? @relation(fields: [ownerId], references: [id])
  tileId  String       @unique
  tile    Tile         @relation(fields: [tileId], references: [id], onDelete: Cascade)
}

enum UnitConstellation {
  r0c0_r0c1
  r0c0_r1c1
  r0c0_r0c1_r1c1
  r0c0_r0c1_r1c2
  r0c0_r0c1_r0c2_r1c2
  r0c0_r0c1_r1c1_r1c2
  r0c0_r0c1_r2c0_r2c1
}

enum UnitType {
  UNIT
  MAIN_BUILDING
}

enum Terrain {
  WATER
  TREE
  STONE
}

enum MatchStatus {
  CREATED
  STARTED
  FINISHED
}

enum Rule {
  TERRAIN_WATER_POSITIVE
  TERRAIN_STONE_NEGATIVE
  HOLE
}
